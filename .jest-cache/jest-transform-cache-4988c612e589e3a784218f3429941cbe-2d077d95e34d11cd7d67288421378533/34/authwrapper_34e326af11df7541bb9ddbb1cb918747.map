{"version":3,"sources":["/home/runner/workspace/src/components/auth/auth-wrapper.tsx"],"sourcesContent":["'use client'\n\nimport { useSession } from 'next-auth/react'\nimport { useRouter } from 'next/navigation'\nimport { ReactNode, useEffect, useState } from 'react'\n\ninterface AuthWrapperProps {\n  children: ReactNode\n  fallback?: ReactNode\n}\n\nexport function AuthWrapper({ children, fallback }: AuthWrapperProps) {\n  const { data: session, status } = useSession()\n  const router = useRouter()\n  const [isServerOnline, setIsServerOnline] = useState(true)\n  const [hasStoredSession, setHasStoredSession] = useState(false)\n\n  // Check if user has stored session data (indicating they were previously logged in)\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      const nextAuthSession =\n        localStorage.getItem('next-auth.session-token') ||\n        localStorage.getItem('__Secure-next-auth.session-token') ||\n        document.cookie.includes('next-auth.session-token') ||\n        document.cookie.includes('__Secure-next-auth.session-token')\n      setHasStoredSession(!!nextAuthSession)\n    }\n  }, [])\n\n  // Check server connectivity when status is unauthenticated\n  useEffect(() => {\n    // Don't redirect during tests\n    if (process.env.NODE_ENV === 'test') {\n      return\n    }\n\n    if (status === 'unauthenticated' && hasStoredSession) {\n      const checkServerStatus = async () => {\n        try {\n          const response = await fetch('/api/health', {\n            method: 'HEAD',\n            cache: 'no-cache',\n            signal: AbortSignal.timeout(5000),\n          })\n\n          if (!response.ok) {\n            setIsServerOnline(false)\n            router.push('/server-offline')\n            return\n          }\n\n          setIsServerOnline(true)\n          // If server is online but user is unauthenticated, redirect to login\n          if (!fallback) {\n            router.push('/auth/v1/login')\n          }\n        } catch (error) {\n          setIsServerOnline(false)\n          router.push('/server-offline')\n        }\n      }\n\n      checkServerStatus()\n    } else if (status === 'unauthenticated' && !hasStoredSession && !fallback) {\n      // No stored session and unauthenticated - direct to login\n      router.push('/auth/v1/login')\n    }\n  }, [status, fallback, router, hasStoredSession])\n\n  if (status === 'loading') {\n    return (\n      <div className=\"bg-background flex h-screen items-center justify-center\">\n        <div className=\"mx-auto max-w-sm space-y-4 px-6 text-center\">\n          <div className=\"relative\">\n            <div className=\"border-muted border-t-primary mx-auto h-12 w-12 animate-spin rounded-full border-4\"></div>\n            <div className=\"border-primary/20 absolute inset-0 mx-auto h-12 w-12 animate-pulse rounded-full border-4\"></div>\n          </div>\n          <div className=\"space-y-2\">\n            <p className=\"text-foreground text-lg font-medium\">Authenticating</p>\n            <p className=\"text-muted-foreground text-sm\">Verifying your Google Drive access...</p>\n          </div>\n          <div className=\"bg-muted mx-auto h-1 w-48 overflow-hidden rounded-full\">\n            <div className=\"bg-primary h-full animate-pulse rounded-full\" style={{ width: '60%' }}></div>\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  if (status === 'unauthenticated') {\n    if (fallback) {\n      return <>{fallback}</>\n    }\n\n    // If we have stored session but are unauthenticated, likely server issue\n    if (hasStoredSession && !isServerOnline) {\n      return (\n        <div className=\"flex h-screen items-center justify-center\">\n          <div className=\"text-center\">\n            <div className=\"border-primary mx-auto mb-2 h-8 w-8 animate-spin rounded-full border-2 border-t-transparent\"></div>\n            <p>Checking server connection...</p>\n          </div>\n        </div>\n      )\n    }\n\n    // Show access denied message for users without stored session\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"text-center\">\n          <p>Access denied. Please sign in.</p>\n        </div>\n      </div>\n    )\n  }\n\n  if (status === 'authenticated' && session) {\n    return <>{children}</>\n  }\n\n  return (\n    <div className=\"flex h-screen items-center justify-center\">\n      <div className=\"border-primary h-8 w-8 animate-spin rounded-full border-2 border-t-transparent\"></div>\n    </div>\n  )\n}\n"],"names":["AuthWrapper","children","fallback","data","session","status","useSession","router","useRouter","isServerOnline","setIsServerOnline","useState","hasStoredSession","setHasStoredSession","useEffect","window","nextAuthSession","localStorage","getItem","document","cookie","includes","process","env","NODE_ENV","checkServerStatus","response","fetch","method","cache","signal","AbortSignal","timeout","ok","push","error","div","className","p","style","width"],"mappings":"AAAA;;;;;+BAWgBA;;;eAAAA;;;;uBATW;4BACD;wBACqB;AAOxC,SAASA,YAAY,EAAEC,QAAQ,EAAEC,QAAQ,EAAoB;IAClE,MAAM,EAAEC,MAAMC,OAAO,EAAEC,MAAM,EAAE,GAAGC,IAAAA,iBAAU;IAC5C,MAAMC,SAASC,IAAAA,qBAAS;IACxB,MAAM,CAACC,gBAAgBC,kBAAkB,GAAGC,IAAAA,gBAAQ,EAAC;IACrD,MAAM,CAACC,kBAAkBC,oBAAoB,GAAGF,IAAAA,gBAAQ,EAAC;IAEzD,oFAAoF;IACpFG,IAAAA,iBAAS,EAAC;QACR,IAAI,OAAOC,WAAW,aAAa;YACjC,MAAMC,kBACJC,aAAaC,OAAO,CAAC,8BACrBD,aAAaC,OAAO,CAAC,uCACrBC,SAASC,MAAM,CAACC,QAAQ,CAAC,8BACzBF,SAASC,MAAM,CAACC,QAAQ,CAAC;YAC3BR,oBAAoB,CAAC,CAACG;QACxB;IACF,GAAG,EAAE;IAEL,2DAA2D;IAC3DF,IAAAA,iBAAS,EAAC;QACR,8BAA8B;QAC9B,IAAIQ,QAAQC,GAAG,CAACC,QAAQ,KAAK,QAAQ;YACnC;QACF;QAEA,IAAInB,WAAW,qBAAqBO,kBAAkB;YACpD,MAAMa,oBAAoB;gBACxB,IAAI;oBACF,MAAMC,WAAW,MAAMC,MAAM,eAAe;wBAC1CC,QAAQ;wBACRC,OAAO;wBACPC,QAAQC,YAAYC,OAAO,CAAC;oBAC9B;oBAEA,IAAI,CAACN,SAASO,EAAE,EAAE;wBAChBvB,kBAAkB;wBAClBH,OAAO2B,IAAI,CAAC;wBACZ;oBACF;oBAEAxB,kBAAkB;oBAClB,qEAAqE;oBACrE,IAAI,CAACR,UAAU;wBACbK,OAAO2B,IAAI,CAAC;oBACd;gBACF,EAAE,OAAOC,OAAO;oBACdzB,kBAAkB;oBAClBH,OAAO2B,IAAI,CAAC;gBACd;YACF;YAEAT;QACF,OAAO,IAAIpB,WAAW,qBAAqB,CAACO,oBAAoB,CAACV,UAAU;YACzE,0DAA0D;YAC1DK,OAAO2B,IAAI,CAAC;QACd;IACF,GAAG;QAAC7B;QAAQH;QAAUK;QAAQK;KAAiB;IAE/C,IAAIP,WAAW,WAAW;QACxB,qBACE,qBAAC+B;YAAIC,WAAU;sBACb,cAAA,sBAACD;gBAAIC,WAAU;;kCACb,sBAACD;wBAAIC,WAAU;;0CACb,qBAACD;gCAAIC,WAAU;;0CACf,qBAACD;gCAAIC,WAAU;;;;kCAEjB,sBAACD;wBAAIC,WAAU;;0CACb,qBAACC;gCAAED,WAAU;0CAAsC;;0CACnD,qBAACC;gCAAED,WAAU;0CAAgC;;;;kCAE/C,qBAACD;wBAAIC,WAAU;kCACb,cAAA,qBAACD;4BAAIC,WAAU;4BAA+CE,OAAO;gCAAEC,OAAO;4BAAM;;;;;;IAK9F;IAEA,IAAInC,WAAW,mBAAmB;QAChC,IAAIH,UAAU;YACZ,qBAAO;0BAAGA;;QACZ;QAEA,yEAAyE;QACzE,IAAIU,oBAAoB,CAACH,gBAAgB;YACvC,qBACE,qBAAC2B;gBAAIC,WAAU;0BACb,cAAA,sBAACD;oBAAIC,WAAU;;sCACb,qBAACD;4BAAIC,WAAU;;sCACf,qBAACC;sCAAE;;;;;QAIX;QAEA,8DAA8D;QAC9D,qBACE,qBAACF;YAAIC,WAAU;sBACb,cAAA,qBAACD;gBAAIC,WAAU;0BACb,cAAA,qBAACC;8BAAE;;;;IAIX;IAEA,IAAIjC,WAAW,mBAAmBD,SAAS;QACzC,qBAAO;sBAAGH;;IACZ;IAEA,qBACE,qBAACmC;QAAIC,WAAU;kBACb,cAAA,qBAACD;YAAIC,WAAU;;;AAGrB"}